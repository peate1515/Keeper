<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Keepers ‚Äî Simulation Draft</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>Keepers ‚Äî Simulation Draft</h1>
  </header>

  <button onclick="location.href='index.html';" class="back-button">Retour √† l'accueil</button>

  <div id="logger" class="logger hidden"></div>

  <div class="sim-layout">
    <aside class="sim-left">
      <div class="panel">
        <h2 class="panel-title">√âquipes</h2>
        <div id="teamTabs"></div>
      </div>

      <div class="panel">
        <h2 class="panel-title">Keepers s√©lectionn√©s ‚Äî <span id="teamLabel"></span></h2>
        <div class="selected-info" id="selectedInfo">Chargement‚Ä¶</div>
        <button id="resetTeamBtn" class="reset-button">R√©initialiser l‚Äô√©quipe</button>
        <ul id="selectedPlayersList"></ul>
      </div>

      <div class="panel">
        <h2 class="panel-title">Roster ‚Äî <span id="teamLabel2"></span></h2>
        <div id="playerList"></div>
      </div>
    </aside>

    <main class="sim-right">
      <div class="panel">
        <div class="board-head">
          <h2 class="panel-title" style="margin:0;">Draft Board (Keepers)</h2>
          <div class="board-actions">
            <button id="lockBoardBtn" class="lock-button" aria-pressed="false">üîì Board d√©verrouill√©</button>
            <button id="resetAllBtn" class="reset-button">R√©initialiser tout</button>
          </div>
        </div>

        <div class="board-wrap" id="boardWrap">
          <table id="draftBoard" class="draft-board"></table>
        </div>

        <div class="board-legend">
          <span class="legend-item"><span class="dot drafted"></span> Rep√™ch√©</span>
          <span class="legend-item"><span class="dot fa"></span> Agent libre</span>
          <span class="legend-item"><span class="dot sel"></span> Keeper plac√©</span>
        </div>
      </div>
    </main>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // =========================================================
    // CONFIG
    // =========================================================
    const EXCEL_PATH = "valeur joueur.xlsx";
    const TEAMS_PATH = "equipe.xlsx";
    const FIRST_GAME_TIME = "13:00";
    const MAX_KEEPERS = 6;
    const ROUNDS = 26;

    // ‚úÖ Ordre des colonnes demand√©
    const TEAM_COLUMN_ORDER = [9, 2, 6, 3, 1, 4, 7, 8, 10, 5];

    // storage
    const LOCK_KEY = "keepers_sim_board_locked_v1";

    // =========================================================
    // TEAM NAMES
    // =========================================================
    let teamNameById = new Map();
    function teamName(teamId){
      return teamNameById.get(Number(teamId)) || `√âquipe ${teamId}`;
    }

    async function loadTeamNames(){
      try{
        const res = await fetch(TEAMS_PATH);
        if (!res.ok) throw new Error(`fetch failed ${res.status}`);
        const buf = await res.arrayBuffer();

        const wb = XLSX.read(buf, { type: "array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

        teamNameById = new Map();
        rows.forEach(r=>{
          const id = Number(r["equipe"] ?? r["√âquipe"] ?? r["Equipe"] ?? "");
          const name = String(r["nom"] ?? r["Nom"] ?? "").trim();
          if (Number.isFinite(id) && name) teamNameById.set(id, name);
        });
      } catch(e){
        teamNameById = new Map();
        console.warn("Impossible de charger equipe.xlsx", e);
      }
    }

    // =========================================================
    // LOGGER
    // =========================================================
    const loggerEl = document.getElementById("logger");
    let loggerTimeout = null;
    function logMessage(message, type = "warn", duration = 4500){
      if (!loggerEl) return;
      loggerEl.textContent = message;
      loggerEl.className = `logger ${type}`;
      loggerEl.classList.remove("hidden");
      clearTimeout(loggerTimeout);
      loggerTimeout = setTimeout(()=>loggerEl.classList.add("hidden"), duration);
    }

    // =========================================================
    // Helpers
    // =========================================================
    function parseExcelDate(v) {
      if (v == null || v === "") return null;
      if (v instanceof Date) return v;
      if (typeof v === "number") {
        const utc_days = Math.floor(v - 25569);
        const utc_value = utc_days * 86400;
        return new Date(utc_value * 1000);
      }
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }
    function parseTimeToMinutes(t) {
      if (t == null || t === "") return null;
      if (t instanceof Date) return t.getHours() * 60 + t.getMinutes();
      if (typeof t === "number") return Math.round(t * 24 * 60);
      if (typeof t === "string") {
        const m = t.trim().match(/^(\d{1,2}):(\d{2})/);
        if (!m) return null;
        return (+m[1]) * 60 + (+m[2]);
      }
      return null;
    }
    function firstGameMinutes() {
      const [h, m] = FIRST_GAME_TIME.split(":").map(Number);
      return h * 60 + m;
    }
    function fmtDate(d){
      if (!d) return "‚Äî";
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const da=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function fmtTime(min){
      if (min == null) return "";
      const h=String(Math.floor(min/60)).padStart(2,"0");
      const m=String(min%60).padStart(2,"0");
      return `${h}:${m}`;
    }
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    // =========================================================
    // Keeper rules
    // =========================================================
    function draftedBonus(roundNum){
      if (roundNum >= 20 && roundNum <= 26) return 3;
      if (roundNum >= 10 && roundNum <= 19) return 2;
      if (roundNum >= 4 && roundNum <= 9) return 1;
      return 0;
    }
    function keeperRoundForDrafted(roundNum){
      return Math.max(1, roundNum - draftedBonus(roundNum));
    }
    function keeperRoundForFreeAgent(selDate, selTimeMin, fgMin){
      if (!selDate) return null;

      const d = new Date(selDate.getFullYear(), selDate.getMonth(), selDate.getDate());
      const y = d.getFullYear();

      const june1 = new Date(y, 5, 1);
      const june2 = new Date(y, 5, 2);
      const aug3  = new Date(y, 7, 3);
      const aug4  = new Date(y, 7, 4);
      const aug31 = new Date(y, 7, 31);

      const beforeFG = (t) => (t == null) ? true : (t < fgMin);

      if (d.getTime() === aug31.getTime()){
        return beforeFG(selTimeMin) ? 10 : null;
      }
      if (d > aug31) return null;

      if (d < june1) return 20;
      if (d.getTime() === june1.getTime()) return beforeFG(selTimeMin) ? 20 : 15;

      if (d >= june2 && d < aug3) return 15;
      if (d.getTime() === aug3.getTime()) return beforeFG(selTimeMin) ? 15 : 10;

      if (d >= aug4 && d < aug31) return 10;

      return null;
    }

    // =========================================================
    // Data + State
    // =========================================================
    let players = [];
    let teamsInFile = [];
    let boardTeams = [];
    let currentTeam = 1;

    let selectionsByTeam = {};
    let boardLocked = false;

    const teamTabsEl = document.getElementById("teamTabs");
    const playerListEl = document.getElementById("playerList");
    const selectedPlayersListEl = document.getElementById("selectedPlayersList");
    const selectedInfoEl = document.getElementById("selectedInfo");
    const teamLabelEl = document.getElementById("teamLabel");
    const teamLabel2El = document.getElementById("teamLabel2");
    const draftBoardEl = document.getElementById("draftBoard");

    function isDrafted(p){
      return p.rank !== "" && p.rank != null;
    }
    function computeKeeperRound(p){
      const fgMin = firstGameMinutes();
      if (isDrafted(p)){
        const r = Number(p.rank);
        if (!Number.isFinite(r)) return null;
        return keeperRoundForDrafted(r);
      } else {
        return keeperRoundForFreeAgent(p.selDate, p.selTimeMin, fgMin);
      }
    }

    function normalizeRow(row){
      const name = String(row["Nom du joueur"] ?? "").trim();
      const team = row["√âquipe"] ?? row["Equipe"] ?? "";
      const rank = row["Rang"] ?? "";
      const selDate = parseExcelDate(row["Date selection"] ?? "");
      const selTimeMin = parseTimeToMinutes(row["Heure selection"] ?? "");
      const originTeam = row["Equipe origine"] ?? "";

      if (!name || team === "" || team == null) return null;

      const p = {
        id: crypto.randomUUID(),
        name,
        team: Number(team),
        rank: (rank === "" || rank == null) ? "" : Number(rank),
        selDate,
        selTimeMin,
        originTeam: (originTeam === "" || originTeam == null) ? "" : Number(originTeam),
      };

      p.type = isDrafted(p) ? "Rep√™ch√©" : "Agent libre";
      p.keeperBase = computeKeeperRound(p);
      p.eligible = (p.keeperBase != null);
      return p;
    }

    function rebuildTeams(){
      teamsInFile = Array.from(new Set(players.map(p=>p.team))).sort((a,b)=>a-b);

      boardTeams = TEAM_COLUMN_ORDER.filter(t => teamsInFile.includes(t));
      const missing = teamsInFile.filter(t => !boardTeams.includes(t));
      boardTeams = boardTeams.concat(missing).slice(0, 10);

      currentTeam = boardTeams.length ? boardTeams[0] : (teamsInFile[0] || 1);
    }

    // =========================================================
    // Storage
    // =========================================================
    function selectionKey(teamId){
      return `keepers_sim_selected_team_${teamId}`;
    }
    function loadTeamSelection(teamId){
      let ids = [];
      try{
        const raw = localStorage.getItem(selectionKey(teamId));
        ids = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(ids)) ids = [];
      } catch { ids = []; }

      ids = [...new Set(ids)]
        .filter(id => players.some(p => p.id === id))
        .slice(0, MAX_KEEPERS);

      selectionsByTeam[teamId] = ids;
    }
    function saveTeamSelection(teamId){
      try{ localStorage.setItem(selectionKey(teamId), JSON.stringify(selectionsByTeam[teamId] || [])); } catch {}
    }
    function loadAllSelections(){
      selectionsByTeam = {};
      teamsInFile.forEach(t => loadTeamSelection(t));
    }

    function loadBoardLock(){
      try{ boardLocked = localStorage.getItem(LOCK_KEY) === "1"; } catch { boardLocked = false; }
      updateLockButtonUI();
    }
    function saveBoardLock(){
      try{ localStorage.setItem(LOCK_KEY, boardLocked ? "1" : "0"); } catch {}
    }

    // =========================================================
    // Priorit√©s d√©partage
    // =========================================================
    function getTimestamp(p){
      const d = p.selDate ? new Date(p.selDate).getTime() : Number.POSITIVE_INFINITY;
      const t = (p.selTimeMin ?? 0) * 60 * 1000;
      return d + t;
    }
    function comparePriority(a, b){
      const ad = isDrafted(a) ? 0 : 1;
      const bd = isDrafted(b) ? 0 : 1;
      if (ad !== bd) return ad - bd;

      if (isDrafted(a) && isDrafted(b)){
        if (a.rank !== b.rank) return b.rank - a.rank;

        const aOriginBetter = (a.originTeam !== "" && a.originTeam != null && a.originTeam < a.team) ? 1 : 0;
        const bOriginBetter = (b.originTeam !== "" && b.originTeam != null && b.originTeam < b.team) ? 1 : 0;
        if (aOriginBetter !== bOriginBetter) return bOriginBetter - aOriginBetter;

        return a.name.localeCompare(b.name, "fr");
      }

      if (!isDrafted(a) && !isDrafted(b)){
        const at = getTimestamp(a);
        const bt = getTimestamp(b);
        if (at !== bt) return at - bt;
        return a.name.localeCompare(b.name, "fr");
      }

      return a.name.localeCompare(b.name, "fr");
    }

    // =========================================================
    // Adjusted calculations (par √©quipe)
    // =========================================================
    function computeAdjustedForIds(selectedIds){
      const picked = selectedIds
        .map(id => players.find(p => p.id === id))
        .filter(Boolean);

      picked.forEach(p=>{
        p.keeperBase = computeKeeperRound(p);
        p.eligible = (p.keeperBase != null);
      });

      const eligiblePicked = picked.filter(p => p.eligible);

      eligiblePicked.sort((a,b)=>{
        const ar = a.keeperBase ?? 999;
        const br = b.keeperBase ?? 999;
        if (ar !== br) return ar - br;
        return comparePriority(a,b);
      });

      const used = {};
      const adjustedMap = new Map();
      eligiblePicked.forEach(p=>{
        let r = p.keeperBase ?? 999;
        while (used[r]) r += 1;
        used[r] = true;
        adjustedMap.set(p.id, r);
      });

      return adjustedMap;
    }

    function buildConflictMessage(clickedPlayerId, beforeMap, afterMap){
      const clicked = players.find(p => p.id === clickedPlayerId);
      if (!clicked) return null;

      const worsened = [];
      for (const [id, afterR] of afterMap.entries()){
        const beforeR = beforeMap.get(id);
        if (beforeR != null && afterR != null && afterR > beforeR){
          const p = players.find(x => x.id === id);
          if (p) worsened.push({ p, beforeR, afterR });
        }
      }

      const impacted = worsened.filter(x => x.p.id !== clickedPlayerId);
      if (!impacted.length) return null;

      impacted.sort((a,b)=> (b.afterR-b.beforeR) - (a.afterR-a.beforeR));
      const top = impacted.slice(0,2);

      const parts = top.map(x => `${x.p.name} de R${x.beforeR} ‚Üí R${x.afterR}`);
      const more = impacted.length > 2 ? ` (+${impacted.length-2} autre${impacted.length-2>1?"s":""})` : "";

      return `‚ö†Ô∏è S√©lectionner ${clicked.name} fait descendre ${parts.join(" et ")}${more}.`;
    }

    // =========================================================
    // Board lock UI
    // =========================================================
    const lockBoardBtn = document.getElementById("lockBoardBtn");
    function updateLockButtonUI(){
      lockBoardBtn.setAttribute("aria-pressed", boardLocked ? "true" : "false");
      lockBoardBtn.textContent = boardLocked ? "üîí Board verrouill√©" : "üîì Board d√©verrouill√©";
      lockBoardBtn.classList.toggle("locked", boardLocked);
    }
    lockBoardBtn.addEventListener("click", ()=>{
      boardLocked = !boardLocked;
      saveBoardLock();
      updateLockButtonUI();
      logMessage(boardLocked ? "Board verrouill√© : clic sur une case ne retire plus un keeper." : "Board d√©verrouill√© : clic sur une case retire un keeper.", "warn", 3500);
      placeKeepersOnBoard();
    });

    // =========================================================
    // UI: Tabs / Selected / Players
    // =========================================================
    function renderTabs(){
      teamTabsEl.innerHTML = "";
      teamsInFile.forEach(t=>{
        const btn = document.createElement("button");
        btn.className = "team-tab" + (t === currentTeam ? " active" : "");
        btn.textContent = teamName(t);
        btn.addEventListener("click", ()=>{
          currentTeam = t;
          refreshAll();
        });
        teamTabsEl.appendChild(btn);
      });
    }

    function renderSelected(){
      teamLabelEl.textContent = teamName(currentTeam);
      teamLabel2El.textContent = teamName(currentTeam);

      selectedPlayersListEl.innerHTML = "";

      const ids = selectionsByTeam[currentTeam] || [];
      const adjustedMap = computeAdjustedForIds(ids);

      const picked = ids.map(id => players.find(p=>p.id===id)).filter(Boolean)
        .map(p => ({ p, adj: adjustedMap.get(p.id) }))
        .filter(x => x.p.eligible);

      picked.sort((a,b)=>{
        if (a.adj !== b.adj) return a.adj - b.adj;
        return comparePriority(a.p, b.p);
      });

      selectedInfoEl.textContent = `${teamName(currentTeam)} ‚Äî ${picked.length} / ${MAX_KEEPERS} s√©lectionn√©s`;

      if (!picked.length){
        const li = document.createElement("li");
        li.className = "empty-li";
        li.textContent = "Aucun keeper s√©lectionn√©.";
        selectedPlayersListEl.appendChild(li);
        return;
      }

      picked.forEach(({p, adj})=>{
        const li = document.createElement("li");
        li.innerHTML = `
          <span class="sel-name">${escapeHtml(p.name)}</span>
          <span class="sel-badges">
            <span class="badge ${isDrafted(p) ? "b-drafted" : "b-fa"}">${escapeHtml(p.type)}</span>
            <span class="badge b-keeper">R${adj}</span>
          </span>
        `;
        selectedPlayersListEl.appendChild(li);
      });
    }

    // scroll + flash
    function highlightBoardCell(teamId, round){
      const td = draftBoardEl.querySelector(`td.board-cell[data-team="${teamId}"][data-round="${round}"]`);
      if (!td) return;
      td.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
      td.classList.remove("flash");
      void td.offsetWidth;
      td.classList.add("flash");
      setTimeout(()=> td.classList.remove("flash"), 1100);
    }

    function togglePlayer(player){
      const teamId = player.team;
      const ids = selectionsByTeam[teamId] || [];
      const already = ids.includes(player.id);

      if (!player.eligible){
        logMessage(`‚ö†Ô∏è ${player.name} n‚Äôest pas √©ligible comme keeper.`, "warn");
        return;
      }

      if (already){
        selectionsByTeam[teamId] = ids.filter(x => x !== player.id);
        saveTeamSelection(teamId);
        refreshAll();
        return;
      }

      if (ids.length >= MAX_KEEPERS){
        logMessage(`‚ö†Ô∏è ${teamName(teamId)}: maximum de ${MAX_KEEPERS} keepers atteint.`, "warn");
        return;
      }

      const beforeMap = computeAdjustedForIds(ids);
      const tentative = [...ids, player.id];
      const afterMap  = computeAdjustedForIds(tentative);

      const msg = buildConflictMessage(player.id, beforeMap, afterMap);
      if (msg) logMessage(`${teamName(teamId)}: ${msg}`, "warn", 5200);

      selectionsByTeam[teamId] = tentative;
      saveTeamSelection(teamId);

      const finalRound = afterMap.get(player.id);
      refreshAll();
      if (finalRound != null) highlightBoardCell(teamId, finalRound);
    }

    function renderPlayers(){
      playerListEl.innerHTML = "";

      const ids = selectionsByTeam[currentTeam] || [];
      const adjustedMap = computeAdjustedForIds(ids);

      const roster = players
        .filter(p => p.team === currentTeam)
        .sort((a,b)=>{
          const ar = (a.keeperBase == null) ? 999 : a.keeperBase;
          const br = (b.keeperBase == null) ? 999 : b.keeperBase;
          if (ar !== br) return ar - br;
          return a.name.localeCompare(b.name, "fr");
        });

      roster.forEach(p=>{
        const selected = ids.includes(p.id);
        const adj = adjustedMap.get(p.id);

        const div = document.createElement("div");
        div.className = "player" +
          (p.eligible ? "" : " non-eligible") +
          (selected ? " selected" : "");

        const keeperTxt = p.eligible ? `Keeper: Round ${p.keeperBase}` : "Non-√©ligible";

        const adjustLine = (selected && p.eligible && adj != null)
          ? `<div class="p-sub p-adjust"><b>Base R${p.keeperBase} ‚Üí Ajust√© R${adj}</b></div>`
          : "";

        let details = "";
        if (p.eligible){
          details = isDrafted(p)
            ? `Rang draft: ${p.rank}`
            : `S√©lection: ${fmtDate(p.selDate)} ${fmtTime(p.selTimeMin)}`;
        } else {
          details = `Apr√®s le cutoff (31 ao√ªt) ou donn√©es manquantes`;
        }

        const originTxt = (p.originTeam === "" || p.originTeam == null)
          ? ""
          : ` ‚Ä¢ Origine: ${teamName(p.originTeam)}`;

        div.innerHTML = `
          <div class="p-title">${escapeHtml(p.name)}</div>
          <div class="p-sub">${escapeHtml(p.type)} ‚Ä¢ <b>${escapeHtml(keeperTxt)}</b></div>
          ${adjustLine}
          <div class="p-sub p-muted">${escapeHtml(details)}${escapeHtml(originTxt)}</div>
        `;

        div.addEventListener("click", ()=>togglePlayer(p));
        playerListEl.appendChild(div);
      });
    }

    // =========================================================
    // Draft Board
    // =========================================================
    function buildEmptyBoard(){
      draftBoardEl.innerHTML = "";

      const thead = document.createElement("thead");
      const hr = document.createElement("tr");

      const th0 = document.createElement("th");
      th0.className = "sticky-col";
      th0.textContent = "Round";
      hr.appendChild(th0);

      boardTeams.forEach(t=>{
        const th = document.createElement("th");
        th.textContent = teamName(t);
        hr.appendChild(th);
      });

      thead.appendChild(hr);
      draftBoardEl.appendChild(thead);

      const tbody = document.createElement("tbody");
      for (let r=1; r<=ROUNDS; r++){
        const tr = document.createElement("tr");

        const tdRound = document.createElement("td");
        tdRound.className = "sticky-col round-cell";
        tdRound.textContent = `R${r}`;
        tr.appendChild(tdRound);

        boardTeams.forEach(t=>{
          const td = document.createElement("td");
          td.className = "board-cell";
          td.dataset.team = t;
          td.dataset.round = r;
          td.innerHTML = `<div class="cell-empty">‚Äî</div>`;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      }
      draftBoardEl.appendChild(tbody);
    }

    function placeKeepersOnBoard(){
      draftBoardEl.querySelectorAll("td.board-cell").forEach(td=>{
        td.classList.remove("cell-filled", "cell-drafted", "cell-fa");
        td.innerHTML = `<div class="cell-empty">‚Äî</div>`;
        td.onclick = null;
      });

      boardTeams.forEach(teamId=>{
        const ids = selectionsByTeam[teamId] || [];
        const adjMap = computeAdjustedForIds(ids);

        ids.forEach(id=>{
          const p = players.find(x=>x.id===id);
          if (!p || !p.eligible) return;

          const round = adjMap.get(id);
          if (!round || round < 1 || round > ROUNDS) return;

          const td = draftBoardEl.querySelector(`td.board-cell[data-team="${teamId}"][data-round="${round}"]`);
          if (!td) return;

          td.classList.add("cell-filled");
          td.classList.add(isDrafted(p) ? "cell-drafted" : "cell-fa");

          td.innerHTML = `
            <div class="cell-player">
              <div class="cell-name">${escapeHtml(p.name)}</div>
              <div class="cell-meta">${isDrafted(p) ? "Rep√™ch√©" : "Agent libre"} ‚Ä¢ Base R${p.keeperBase}</div>
              <div class="cell-remove">${boardLocked ? "Board verrouill√©" : "Cliquer pour retirer"}</div>
            </div>
          `;

          td.onclick = () => {
            if (boardLocked){
              logMessage("üîí Board verrouill√© : d√©verrouille pour retirer un keeper.", "warn", 3000);
              return;
            }
            selectionsByTeam[teamId] = (selectionsByTeam[teamId] || []).filter(x => x !== p.id);
            saveTeamSelection(teamId);
            refreshAll();
          };
        });
      });
    }

    // =========================================================
    // Reset buttons
    // =========================================================
    document.getElementById("resetTeamBtn").addEventListener("click", ()=>{
      selectionsByTeam[currentTeam] = [];
      saveTeamSelection(currentTeam);
      logMessage(`${teamName(currentTeam)}: s√©lection r√©initialis√©e.`, "warn", 2500);
      refreshAll();
    });

    document.getElementById("resetAllBtn").addEventListener("click", ()=>{
      teamsInFile.forEach(t=>{
        selectionsByTeam[t] = [];
        saveTeamSelection(t);
      });
      logMessage("Toutes les s√©lections ont √©t√© r√©initialis√©es.", "warn", 2500);
      refreshAll();
    });

    function refreshAll(){
      renderTabs();
      renderSelected();
      renderPlayers();
      placeKeepersOnBoard();
    }

    // =========================================================
    // Load excel
    // =========================================================
    async function loadExcelFromRepo(){
      try{
        selectedInfoEl.textContent = "Chargement du fichier‚Ä¶";

        const res = await fetch(EXCEL_PATH);
        if (!res.ok) throw new Error(`fetch failed ${res.status}`);
        const buf = await res.arrayBuffer();

        const wb = XLSX.read(buf, { type: "array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(ws, { defval: "" });

        players = [];
        for (const row of raw){
          const p = normalizeRow(row);
          if (p) players.push(p);
        }

        rebuildTeams();
        loadAllSelections();
        loadBoardLock();

        buildEmptyBoard();
        refreshAll();

      } catch (e){
        selectedInfoEl.textContent = "Erreur: impossible de charger le fichier Excel.";
        playerListEl.innerHTML = `
          <div class="player non-eligible">
            Impossible de charger <b>${escapeHtml(EXCEL_PATH)}</b>.<br>
            V√©rifie que le fichier est dans le repo (m√™me dossier) et que le nom est EXACT (espaces inclus).
          </div>`;
        console.error(e);
      }
    }

    (async ()=>{
      await loadTeamNames();
      await loadExcelFromRepo();
    })();
  </script>
</body>
</html>
